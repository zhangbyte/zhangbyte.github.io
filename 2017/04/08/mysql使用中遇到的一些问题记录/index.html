<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>mysql使用中遇到的一些问题记录 | Zbyte's Blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">mysql使用中遇到的一些问题记录</h1><a id="logo" href="/.">Zbyte's Blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">mysql使用中遇到的一些问题记录</h1><div class="post-meta">Apr 8, 2017<span> | </span><span class="category"><a href="/categories/database/">database</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p>使用mysql进行开发遇到过各种各样的问题,在此记录下方便以后查询.<br><a id="more"></a></p>
<h2 id="数据库连接超时问题"><a href="#数据库连接超时问题" class="headerlink" title="数据库连接超时问题"></a>数据库连接超时问题</h2><p>近期开发的一个项目,早上学弟使用频频出现500错误,但是刷新后又正常.去服务器看了下tomcat的日志,发现了一个问题.<br>日志目录: <code>tomcat/logs/localhost.2017-03-16.log</code><br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="number">16</span>-Mar<span class="number">-2017</span> <span class="number">10</span>:<span class="number">02</span>:<span class="number">08.180</span> SEVERE [<span class="keyword">http</span>-nio<span class="number">-8082</span>-exec<span class="number">-206</span>] org.apache.catalina.core.StandardWrapperValve.invoke Servlet.service() <span class="keyword">for</span> servlet [fireant-dispatcher] <span class="keyword">in</span> context <span class="keyword">with</span> path [] threw exception [Request processing failed; nested exception is org.springframework.dao.RecoverableDataAccessException: </div><div class="line"><span class="comment">### Error querying database.  Cause: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The last packet successfully received from the server was78793 seconds ago.The last packet sent successfully to the server was 78793 seconds ago, which  is longer than the server configured value of 'wait_timeout'. You should consider either expiring and/or testing connection validity before use in your application, increasing the server configured values for client timeouts, or using the Connector/J connection property 'autoReconnect=true' to avoid this problem.</span></div><div class="line"><span class="comment">### The error may exist in file [/opt/www/fireant/ROOT/WEB-INF/classes/mapper/UserDao.xml]</span></div><div class="line"><span class="comment">### The error may involve org.duohuo.fireant.dao.UserDao.queryById-Inline</span></div><div class="line"><span class="comment">### The error occurred while setting parameters</span></div><div class="line"><span class="comment">### SQL: select user_id, id, name, state, times, study_time, msg   from user   where user_id = ?</span></div><div class="line"><span class="comment">### Cause: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The last packet successfully received from the server was78793 seconds ago.The last packet sent successfully to the server was 78793 seconds ago, which  is longer than the server configured value of 'wait_timeout'. You should consider either expiring and/or testing connection validity before use in your application, increasing the server configured values for client timeouts, or using the Connector/J connection property 'autoReconnect=true' to avoid this problem.</span></div><div class="line">; SQL []; The <span class="keyword">last</span> packet successfully received <span class="built_in">from</span> <span class="keyword">the</span> server was78793 <span class="built_in">seconds</span> ago.The <span class="keyword">last</span> packet sent successfully <span class="built_in">to</span> <span class="keyword">the</span> server was <span class="number">78793</span> <span class="built_in">seconds</span> ago, which  is longer than <span class="keyword">the</span> server configured <span class="built_in">value</span> <span class="keyword">of</span> <span class="string">'wait_timeout'</span>. You should consider either expiring <span class="keyword">and</span>/<span class="keyword">or</span> testing connection validity <span class="keyword">before</span> use <span class="keyword">in</span> your application, increasing <span class="keyword">the</span> server configured values <span class="keyword">for</span> client timeouts, <span class="keyword">or</span> <span class="keyword">using</span> <span class="keyword">the</span> Connector/J connection property <span class="string">'autoReconnect=true'</span> <span class="built_in">to</span> avoid this problem.; nested exception is com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The <span class="keyword">last</span> packet successfully received <span class="built_in">from</span> <span class="keyword">the</span> server was78793 <span class="built_in">seconds</span> ago.The <span class="keyword">last</span> packet sent successfully <span class="built_in">to</span> <span class="keyword">the</span> server was <span class="number">78793</span> <span class="built_in">seconds</span> ago, which  is longer than <span class="keyword">the</span> server configured <span class="built_in">value</span> <span class="keyword">of</span> <span class="string">'wait_timeout'</span>. You should consider either expiring <span class="keyword">and</span>/<span class="keyword">or</span> testing connection validity <span class="keyword">before</span> use <span class="keyword">in</span> your application, increasing <span class="keyword">the</span> server configured values <span class="keyword">for</span> client timeouts, <span class="keyword">or</span> <span class="keyword">using</span> <span class="keyword">the</span> Connector/J connection property <span class="string">'autoReconnect=true'</span> <span class="built_in">to</span> avoid this problem.] <span class="keyword">with</span> root cause</div><div class="line"> java.net.SocketException: Broken pipe</div><div class="line">	......</div></pre></td></tr></table></figure></p>
<p>上网搜了下,发现这个错误的原因是连接超时问题.mysql数据库连接有效时长默认8小时,超过8小时后会自动失效,若程序继续使用该连接,即会报上述错误.  </p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><ol>
<li>修改mysql配置项<code>wait_timeout</code><br>不过此方法毕竟不是长久之际,时长再长还是有可能过期</li>
<li>连接URL后加<code>autoReconnect=true</code><br>这个方法网上说有些版本的mysql失效,具体原因不知,所以我没有尝试  </li>
<li>因为我使用了c3p0连接池,所以查询了c3p0配置项,发现有两个属性可以解决这个问题  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--最大空闲时间,1800秒内未使用则连接被丢弃。若为0则永不丢弃。Default: 0 --&gt;</span>   </div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdleTime"</span> <span class="attr">value</span>=<span class="string">"1800"</span> /&gt;</span></div></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--每60秒检查所有连接池中的空闲连接。Default: 0 --&gt;</span>   </div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"idleConnectionTestPeriod"</span> <span class="attr">value</span>=<span class="string">"60"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p>以上两种方法按描述均可避免这个超时问题,具体孰优孰劣我也不清楚</p>
<h2 id="微信nickname包含emoji存储问题"><a href="#微信nickname包含emoji存储问题" class="headerlink" title="微信nickname包含emoji存储问题"></a>微信nickname包含emoji存储问题</h2><p>最近开发捐赠系统,实现微信web授权登录,结果测试时遇到一个昵称含有emoji的用户存储用户信息时失败,查看错误日志如下:<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="number">07</span>-Apr<span class="number">-2017</span> <span class="number">17</span>:<span class="number">25</span>:<span class="number">46.612</span> SEVERE [<span class="keyword">http</span>-nio<span class="number">-8083</span>-exec<span class="number">-49</span>] org.apache.catalina.core.StandardWrapperValve.invoke Servlet.service() <span class="keyword">for</span> servlet [dispatcher] <span class="keyword">in</span> context <span class="keyword">with</span> path [] threw exception [Request processing failed; nested exception is org.springframework.jdbc.UncategorizedSQLException: PreparedStatementCallback; uncategorized SQLException <span class="keyword">for</span> SQL [insert <span class="keyword">into</span> user (openid, nickname, head_img) values (?,?,?)]; SQL state [HY000]; error code [<span class="number">1366</span>]; Incorrect <span class="keyword">string</span> <span class="built_in">value</span>: <span class="string">'\xF0\x9F\x8D\xAD'</span> <span class="keyword">for</span> column <span class="string">'nickname'</span> <span class="keyword">at</span> row <span class="number">1</span>; nested exception is java.sql.SQLException: Incorrect <span class="keyword">string</span> <span class="built_in">value</span>: <span class="string">'\xF0\x9F\x8D\xAD'</span> <span class="keyword">for</span> column <span class="string">'nickname'</span> <span class="keyword">at</span> row <span class="number">1</span>] <span class="keyword">with</span> root cause</div><div class="line"> java.sql.SQLException: Incorrect <span class="keyword">string</span> <span class="built_in">value</span>: <span class="string">'\xF0\x9F\x8D\xAD'</span> <span class="keyword">for</span> column <span class="string">'nickname'</span> <span class="keyword">at</span> row <span class="number">1</span></div><div class="line">	<span class="keyword">at</span> com.mysql.jdbc.SQLError.createSQLException(SQLError.java:<span class="number">964</span>)</div><div class="line">	......</div></pre></td></tr></table></figure></p>
<p>原来是编码问题,上网一搜,发现好多人都遇到过这个问题,而且大多是微信nickname包含emoji时遇到的.<br>mysql的utf-8只能存储1~3个字节的数据,而emoji包含4个字节,所以报错.要存储4个字节的数据,需要修改编码为utf8mb4,而mysql5.5后才支持utf8mb4编码.</p>
<h4 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h4><p>可以修改当前数据库或者表的编码方式为utf8mb4,其实没必要,只要建表的时候在对应的字段后加编码即可<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">`nickname` varchar(50) CHARACTER <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'微信昵称'</span></div></pre></td></tr></table></figure></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://zhangbyte.github.io/2017/04/08/mysql使用中遇到的一些问题记录/" data-id="cj77970jo000mfbnu6wn5a2ut" class="article-share-link">分享到</a><div class="tags"><a href="/tags/mysql/">mysql</a></div><div class="post-nav"><a href="/2017/05/02/约瑟夫问题II/" class="pre">约瑟夫问题II</a><a href="/2017/03/27/MAVEN使用笔记/" class="next">MAVEN使用笔记</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/database/">database</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/maven/" style="font-size: 15px;">maven</a> <a href="/tags/test/" style="font-size: 15px;">test</a> <a href="/tags/weixin/" style="font-size: 15px;">weixin</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/Mockito和EasyMock比较/">Mockito和EasyMock比较</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/31/微信网页授权实现扫码登录/">微信网页授权实现扫码登录</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/02/约瑟夫问题II/">约瑟夫问题II</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/08/mysql使用中遇到的一些问题记录/">mysql使用中遇到的一些问题记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/27/MAVEN使用笔记/">MAVEN使用笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/27/hello-world/">Hello World</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Zbyte's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>